<div class="wikidoc"><h1>Build Analytics</h1>
<br /><br /><div style="clear:both;height:0;">&nbsp;</div><img style="float:left;padding-right:.5em;" src="http://download-codeplex.sec.s-msft.com/Download?ProjectName=wolfpack&DownloadId=252513" alt="build.png" title="build.png" /> One of the areas ripe for monitoring is your development build - it is important to get notifications for build failures plus there is a slew of information that is generated by a typical build process. Leveraging Wolfpack&#39;s plugin architecture it&#39;s been an easy task to create a set of plugins that allow you to monitor your TeamCity build status and extract information from reports generated by tools run during the build process such as NCover, SpecFlow and StoryQ. It is also a simple task to further extend this range of plugins to extract statistics from other tools and track the build state from other build systems such as TFS, CruiseControl etc.<br /><br />The Build Analytics feature works by first setting up a Health Check to track the build state. As a new build is detected a result message is generated (this contains the state of the build, pass or fail) and this is passed to all the Publishers you have configured (as per normal wolfpack behavior). However Build Analytics provides some special Publishers - these Publishers will only trigger when a result message from a specific source arrives (your build check) and their function is to parse a build tool report file (eg: ncover output), extract the important information from it and then publish this data as further Health Check result messages. This approach means you can tailor which parsers to run once the build has completed - your build  might run StoryQ but not NCover, no problem - just enable the parsers that you need! You can set up as many build checks &amp; parsers as required.<br /><br />The final piece of this feature is to ensure we can easily visualise the extracted report information - the Wolfpack Geckoboard Data Service allows us to connect Wolfpack directly into Geckoboard to quickly display your build statistics.<br /><br />Build Systems supported include...
<ul><li>TeamCity</li></ul>
Build Tools supported include...
<ul><li>NCover summary report (html), extracting...
<ul><li>Branch, Symbol and Method coverage %</li>
<li>Cyclomatic complexity</li></ul></li>
<li>SpecFlow xml report extracting...
<ul><li>Success rate %</li>
<li>Total number of specifications</li>
<li>Number of Successes, failures, pending and ignored</li></ul></li>
<li>StoryQ xml report extracting...
<ul><li>The number for each result category</li></ul></li>
<li>Other stats...
<ul><li>Build duration</li></ul></li></ul>

<h2>Walk Thru</h2>These are the steps required to connect your TeamCity build to Geckoboard to expose stats from your NCover &amp; SpecFlow output.<br /><br />1. The Config\buildanalytics.castle.config file contains four component entries...we are going to configure the &quot;CoverageBuildNotificationCheckConfig&quot; one to detect new builds. Note: you can create as many of these build notifications as required - eg: 1 per build that you want to know the status of or extract the stats from. Just remember to also create a new binding for it (copy the &quot;CoverageBuildNotificationBindingConfig&quot; component).<br /><div style="color:Black;background-color:White;"><pre>
    <span style="color:Blue;">&lt;</span><span style="color:#A31515;">component</span> <span style="color:Red;">id</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">CoverageBuildNotificationCheckConfig</span><span style="color:Black;">&quot;</span> <span style="color:Red;">lifestyle</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">singleton</span><span style="color:Black;">&quot;</span> 
               <span style="color:Red;">type</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">Wolfpack.Contrib.BuildAnalytics.Checks.TeamCityBuildNotificationCheckConfig, Wolfpack.Contrib.BuildAnalytics</span><span style="color:Black;">&quot;</span><span style="color:Blue;">&gt;</span>
      <span style="color:Blue;">&lt;</span><span style="color:#A31515;">parameters</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">FriendlyId</span><span style="color:Blue;">&gt;</span>CoverageBuildNotification<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">FriendlyId</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">Enabled</span><span style="color:Blue;">&gt;</span>false<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">Enabled</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">BuildServerUrl</span><span style="color:Blue;">&gt;</span><span style="color:Blue;">&lt;/</span><span style="color:#A31515;">BuildServerUrl</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">UserId</span><span style="color:Blue;">&gt;</span><span style="color:Blue;">&lt;/</span><span style="color:#A31515;">UserId</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">Password</span><span style="color:Blue;">&gt;</span><span style="color:Blue;">&lt;/</span><span style="color:#A31515;">Password</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">UseSsl</span><span style="color:Blue;">&gt;</span>false<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">UseSsl</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">TrustDuffSslCertificate</span><span style="color:Blue;">&gt;</span>false<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">TrustDuffSslCertificate</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">ProjectName</span><span style="color:Blue;">&gt;</span><span style="color:Blue;">&lt;/</span><span style="color:#A31515;">ProjectName</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">ConfigurationName</span><span style="color:Blue;">&gt;</span><span style="color:Blue;">&lt;/</span><span style="color:#A31515;">ConfigurationName</span><span style="color:Blue;">&gt;</span>
      <span style="color:Blue;">&lt;/</span><span style="color:#A31515;">parameters</span><span style="color:Blue;">&gt;</span>
    <span style="color:Blue;">&lt;/</span><span style="color:#A31515;">component</span><span style="color:Blue;">&gt;</span>
</pre></div>2. Update the <b>Enabled</b> property to true<br /><br />3. Set the <b>BuildServerUrl</b> to your TeamCity project url, usually something like http://<i>buildserver</i>:8080<br /><br />4. Set the <b>UserId</b> and <b>Password</b> properties to your TeamCity credentials<br /><br />5. If your server uses SSL then set the <b>UseSsl</b> property to true, also if the certificate is self-certified then also set the <b>TrustDuffSslCertificate</b> property to true<br /><br />6. Set the <b>ProjectName</b> and <b>ConfigurationName</b> property to the TeamCity project name and build configuration name respectively.<br /><br />7. We need to enable the build parsers, one for the NCover report and one for the SpecFlow report.<br /><br />8. In the Config\buildparser.castle.config file set up two components - one will handle parsing the NCover report and the other the SpecFlow report. An important field is the <b>TargetHealthCheckName</b> property. The value here must match the <b>FriendlyId</b> property of the build notification component configured in step 1. TeamCity artifacts are zip files so the SpecFlow and NCover reports will be extracted from these then parsed. The <b>ZipFileTemplate</b> property should be set to the path to the respective zip file - however this path usually will contain the build number so the {buildid} token should be used and the actual build id value (included in the build notification result) will be substituted. The <b>ReportFileTemplate</b> property allows you to specify the filename (including path) <i>within</i> the zip.<br /><br /><b>NOTE</b> If your build output is <b>NOT</b> a zip archive then leave the <b>ZipFileTemplate</b> property blank and just set the full path (including the {buildid} token if required) to the uncompressed report file in the <b>ReportFileTemplate</b> property.<br /><div style="color:Black;background-color:White;"><pre>
    <span style="color:Blue;">&lt;</span><span style="color:#A31515;">component</span> <span style="color:Red;">id</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">SpecFlowParserConfig</span><span style="color:Black;">&quot;</span> <span style="color:Red;">lifestyle</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">singleton</span><span style="color:Black;">&quot;</span> 
               <span style="color:Red;">type</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">Wolfpack.Contrib.BuildAnalytics.Parsers.SpecFlowHtmlReportParserConfig, Wolfpack.Contrib.BuildAnalytics</span><span style="color:Black;">&quot;</span><span style="color:Blue;">&gt;</span>
      <span style="color:Blue;">&lt;</span><span style="color:#A31515;">parameters</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">FriendlyId</span><span style="color:Blue;">&gt;</span>SpecFlowParser<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">FriendlyId</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">Enabled</span><span style="color:Blue;">&gt;</span>true<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">Enabled</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">TargetHealthCheckName</span><span style="color:Blue;">&gt;</span>CoverageBuildNotification<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">TargetHealthCheckName</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">ZipFileTemplate</span><span style="color:Blue;">&gt;</span>c:\builds\{buildid}\acceptance.zip<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">ZipFileTemplate</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">ReportFileTemplate</span><span style="color:Blue;">&gt;</span>AcceptanceReport.html<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">ReportFileTemplate</span><span style="color:Blue;">&gt;</span>
      <span style="color:Blue;">&lt;/</span><span style="color:#A31515;">parameters</span><span style="color:Blue;">&gt;</span>
    <span style="color:Blue;">&lt;/</span><span style="color:#A31515;">component</span><span style="color:Blue;">&gt;</span>

    <span style="color:Blue;">&lt;</span><span style="color:#A31515;">component</span> <span style="color:Red;">id</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">NCoverParserConfig</span><span style="color:Black;">&quot;</span> <span style="color:Red;">lifestyle</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">singleton</span><span style="color:Black;">&quot;</span> 
               <span style="color:Red;">type</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">Wolfpack.Contrib.BuildAnalytics.Parsers.NCoverHtmlSummaryReportParserConfig, Wolfpack.Contrib.BuildAnalytics</span><span style="color:Black;">&quot;</span><span style="color:Blue;">&gt;</span>
      <span style="color:Blue;">&lt;</span><span style="color:#A31515;">parameters</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">FriendlyId</span><span style="color:Blue;">&gt;</span>NCoverParser<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">FriendlyId</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">Enabled</span><span style="color:Blue;">&gt;</span>true<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">Enabled</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">TargetHealthCheckName</span><span style="color:Blue;">&gt;</span>CoverageBuildNotification<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">TargetHealthCheckName</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">ZipFileTemplate</span><span style="color:Blue;">&gt;</span>c:\builds\{buildid}\coverage.zip<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">ZipFileTemplate</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">ReportFileTemplate</span><span style="color:Blue;">&gt;</span>coveragesummary.html<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">ReportFileTemplate</span><span style="color:Blue;">&gt;</span>
      <span style="color:Blue;">&lt;/</span><span style="color:#A31515;">parameters</span><span style="color:Blue;">&gt;</span>
    <span style="color:Blue;">&lt;/</span><span style="color:#A31515;">component</span><span style="color:Blue;">&gt;</span>
</pre></div><br />9. We now need to expose this information to Geckoboard...we will need to enable a storage <a href="https://wolfpack.codeplex.com/wikipage?title=Configuring%20Publishers&referringTitle=Build%20Analytics">publisher</a> and the <a href="https://wolfpack.codeplex.com/wikipage?title=Activities&referringTitle=Build%20Analytics">Geckoboard Data Service activity</a>. To enable a storage publisher open the Config\publisher.castle.config file and set the <b>Enabled</b> property to true on either the SQLitePublisher or SqlServerPublisher component.<br /><br />10. Enable the Geckoboard Data Service by setting these properties in the activity.castle.config file. Set the <b>Enabled</b> to true on the GeckoboardDataServiceActivityConfig component and on the GeckoboardDataServiceConfig component set the <b>DataProvider</b> property to match your publisher choice in step 9 - use values &quot;SQLite&quot; or &quot;SqlServer&quot;.<br /><div style="color:Black;background-color:White;"><pre>
    <span style="color:Blue;">&lt;</span><span style="color:#A31515;">component</span> <span style="color:Red;">id</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">GeckoboardDataServiceActivityConfig</span><span style="color:Black;">&quot;</span>
				   <span style="color:Red;">lifestyle</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">singleton</span><span style="color:Black;">&quot;</span>
				   <span style="color:Red;">type</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">Wolfpack.Core.Geckoboard.GeckoboardDataServiceActivityConfig, Wolfpack.Core</span><span style="color:Black;">&quot;</span><span style="color:Blue;">&gt;</span>
      <span style="color:Blue;">&lt;</span><span style="color:#A31515;">parameters</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">Enabled</span><span style="color:Blue;">&gt;</span>true<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">Enabled</span><span style="color:Blue;">&gt;</span>
        <span style="color:Green;">&lt;!-- This must be the service implementation class name including the namespace --&gt;</span>        
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">ServiceImplementation</span><span style="color:Blue;">&gt;</span>Wolfpack.Core.Geckoboard.GeckoboardDataService, Wolfpack.Core<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">ServiceImplementation</span><span style="color:Blue;">&gt;</span>
        <span style="color:Green;">&lt;!-- The base address that the service is available at
             Currently Geckoboard only supports Http at port 80 --&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">Uri</span><span style="color:Blue;">&gt;</span>http://localhost/Geckoboard<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">Uri</span><span style="color:Blue;">&gt;</span>
        <span style="color:Green;">&lt;!-- An ApiKey is set up on each Geckoboard widget. Use the same one and 
             set this value to it to ensure only requests with this ApiKey will be 
             returned your monitoring data. Omit this property or leave blank to disable 
             the ApiKey security --&gt;</span>
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">ApiKey</span><span style="color:Blue;">&gt;</span><span style="color:Blue;">&lt;/</span><span style="color:#A31515;">ApiKey</span><span style="color:Blue;">&gt;</span>
      <span style="color:Blue;">&lt;/</span><span style="color:#A31515;">parameters</span><span style="color:Blue;">&gt;</span>
    <span style="color:Blue;">&lt;/</span><span style="color:#A31515;">component</span><span style="color:Blue;">&gt;</span>
    
        <span style="color:Blue;">&lt;</span><span style="color:#A31515;">component</span> <span style="color:Red;">id</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">GeckoboardDataServiceConfig</span><span style="color:Black;">&quot;</span>
				       <span style="color:Red;">lifestyle</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">singleton</span><span style="color:Black;">&quot;</span>
				       <span style="color:Red;">type</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">Wolfpack.Core.Geckoboard.GeckoboardDataServiceConfig, Wolfpack.Core</span><span style="color:Black;">&quot;</span><span style="color:Blue;">&gt;</span>
          <span style="color:Blue;">&lt;</span><span style="color:#A31515;">parameters</span><span style="color:Blue;">&gt;</span>
            <span style="color:Green;">&lt;!-- Possible values are SQLite, SqlServer --&gt;</span>
            <span style="color:Blue;">&lt;</span><span style="color:#A31515;">DataProvider</span><span style="color:Blue;">&gt;</span>SQLite<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">DataProvider</span><span style="color:Blue;">&gt;</span>
          <span style="color:Blue;">&lt;/</span><span style="color:#A31515;">parameters</span><span style="color:Blue;">&gt;</span>
        <span style="color:Blue;">&lt;/</span><span style="color:#A31515;">component</span><span style="color:Blue;">&gt;</span>
</pre></div>11. (Re)start Wolfpack to pick up these config changes. <br /><br />12.  Connect Wolfpack to Geckoboard to display your build stats. Remember to ensure internet connectivity to the server running Wolfpack - ensure firewalls and port forwarding are configured. The simplest way to view your NCover and SpecFlow numbers is using Geckoboard Number Comparison widgets (piechart and geck-o-meter widgets soon to be supported). The comparison widget will display the last value with a +/-% compared to the previous build value. The url to enter into the Geckoboard widget to display the NCover branch coverage % number is...<br /><br />http://<i>hostname</i>/geckoboard/comparison/sites/sitea/<b>CoverageBuildNotification</b>-NCover?tag=branch<br /><br />Other supported stats are selected by replacing the tag parameter with...
<ul><li>symbol</li>
<li>method</li>
<li>complexity (for cyclomatic complexity figure)</li></ul>
<br />The magic ingredient here is the <b>CoverageBuildNotification</b> value highlighted - this must be the same value that we originally used in the build notification component <b>FriendlyId</b> property back in step 1 and also used in step 8 as the <b>TargetHealthCheckName</b> property value. If you set up further build analytics then ensure that this name is unique and used throughout the notification, parser and geckoboard url locations.<br /><br />The url to display the SpecFlow success rate % is...<br /><br />http://<i>hostname</i>/geckoboard/comparison/sites/sitea/<b>CoverageBuildNotification</b>-SpecFlow?tag=SuccessRate<br /><br />Other supported stats are selected by replacing the tag parameter with...
<ul><li>Total</li>
<li>Success</li>
<li>Failures</li>
<li>Pending</li>
<li>Ignored</li></ul>
<br />The remaining Geckoboard widget properties that <b>must</b> be set are...
<ul><li>Widget type = Custom</li>
<li>Feed format = JSON</li>
<li>Request Type = POST</li></ul>
<br />You can also visualise these stats with a &quot;Geck-o-meter&quot; widget - the url format is, (for NCover branch coverage %)<br /><br />http://<i>hostname</i>/geckoboard/geckometer/<b>CoverageBuildNotification</b>-NCover?tag=branch<br /><br /><img src="http://download-codeplex.sec.s-msft.com/Download?ProjectName=wolfpack&DownloadId=253189" alt="buildanalytics-meter.png" title="buildanalytics-meter.png" /><br />
<h3>Example Dashboard</h3>Here is an example dashboard from a project of mine - the line chart is the duration (in seconds) of the coverage build (teamcity build configuration that runs the code coverage) and the remaining numbers are the current values of the coverage and specflow reports (with the % delta from the last build).<br /><br /><img src="http://download-codeplex.sec.s-msft.com/Download?ProjectName=wolfpack&DownloadId=253106" alt="buildanalytics.png" title="buildanalytics.png" /><br />
<h2>Bonus Stuff</h2>Since the build notification appears as a regular Health Check result it can leverage all the same publishers including Growl - this means you can get desktop notifications when your build completes - even better forward these on to your smartphone so you are always up to date with your build status!<br /><br />The other bonus is that the duration of the build is also reported in the result, the ResultCount property contains the build duration in seconds. This means you could plot this with the Geckoboard Linechart widget to get an instant indicator of your build performance. The url for the build duration linechart is,<br /><br />http://<i>hostname</i>/geckoboard/linechart/<b>CoverageBuildNotification</b>/success<br /><br />Just replace the <b>CoverageBuildNotification</b> value with the name of your build (also in step 1 &amp; 8)<br /></div><div class="ClearBoth"></div>